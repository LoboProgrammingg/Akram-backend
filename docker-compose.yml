version: "3.8"

services:
  # =============================================
  # PostgreSQL 16
  # =============================================
  postgres:
    image: postgres:16-alpine
    container_name: akram_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: akram
      POSTGRES_PASSWORD: akram_secret_2026
      POSTGRES_DB: akram_db
    ports:
      - "5434:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U akram -d akram_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - akram-network

  # =============================================
  # Evolution API 1.8.2 — WhatsApp Integration
  # =============================================
  evolution-api:
    image: atendai/evolution-api:v1.8.2
    container_name: akram_evolution
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Server
      SERVER_URL: http://localhost:8080
      SERVER_PORT: 8080
      
      # Authentication
      AUTHENTICATION_TYPE: apikey
      AUTHENTICATION_API_KEY: ${EVOLUTION_API_KEY:-akram-evolution-key-2026}
      AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES: "true"
      
      # Database (using same PostgreSQL)
      DATABASE_ENABLED: "false"
      # DATABASE_PROVIDER: postgresql
      # DATABASE_CONNECTION_URI: postgresql://akram:akram_secret_2026@postgres:5432/akram_db
      # DATABASE_CONNECTION_CLIENT_NAME: evolution_api
      
      # Instance settings
      DEL_INSTANCE: "false"
      CONFIG_SESSION_PHONE_CLIENT: Akram Monitor
      CONFIG_SESSION_PHONE_NAME: Chrome
      
      # Webhook
      WEBHOOK_GLOBAL_URL: http://backend:8000/api/webhook/evolution
      WEBHOOK_GLOBAL_ENABLED: "true"
      WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS: "true"
      WEBHOOK_EVENTS_MESSAGES_UPSERT: "true"
      WEBHOOK_EVENTS_STATUS_INSTANCE: "true"
      WEBHOOK_EVENTS_QRCODE_UPDATED: "true"
      WEBHOOK_EVENTS_CONNECTION_UPDATE: "true"
      
      # QR Code
      QRCODE_LIMIT: 30
      QRCODE_COLOR: "#3b82f6"
      
      # Log
      LOG_LEVEL: DEBUG
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - akram-network

  # =============================================
  # Akram Backend — FastAPI
  # =============================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: akram_backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql+psycopg2://akram:akram_secret_2026@postgres:5432/akram_db
      SECRET_KEY: ${SECRET_KEY:-JjhQppOHCqxxufLiNcIqolr3AA8QfDfS}
      TIMEZONE: America/Cuiaba
      AI_PROVIDER: ${AI_PROVIDER:-gemini}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      EVOLUTION_API_URL: http://evolution-api:8080
      EVOLUTION_API_KEY: ${EVOLUTION_API_KEY:-akram-evolution-key-2026}
      EVOLUTION_INSTANCE: ${EVOLUTION_INSTANCE:-akram}
    volumes:
      - backend_data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
      evolution-api:
        condition: service_started
    networks:
      - akram-network

networks:
  akram-network:
    driver: bridge

volumes:
  pgdata:
  evolution_instances:
  evolution_store:
  backend_data:
